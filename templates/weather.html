{% extends "base.html" %}

{% block title %}{{ city }} Weather - Weather Dashboard{% endblock %}

{% block content %}
<div class="weather-container">
    <div class="back-button">
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to City Selection
        </a>
    </div>
    
    <div class="weather-header">
        <h2 id="cityName">{{ city }}</h2>
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading weather data...
        </div>
    </div>
    
    <div class="weather-content" id="weatherContent" style="display: none;">
        <div class="weather-main">
            <div class="current-weather">
                <div class="weather-icon">
                    <img id="weatherIcon" src="" alt="Weather Icon">
                </div>
                <div class="temperature">
                    <span id="temperature">--</span>°C
                    <div class="feels-like">
                        Feels like <span id="feelsLike">--</span>°C
                    </div>
                </div>
                <div class="weather-description">
                    <span id="description">--</span>
                </div>
            </div>
            
            <div class="weather-details">
                <div class="detail-item">
                    <i class="fas fa-tint"></i>
                    <span class="label">Humidity</span>
                    <span class="value" id="humidity">--%</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-gauge-high"></i>
                    <span class="label">Pressure</span>
                    <span class="value" id="pressure">-- hPa</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-wind"></i>
                    <span class="label">Wind Speed</span>
                    <span class="value" id="windSpeed">-- m/s</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-eye"></i>
                    <span class="label">Visibility</span>
                    <span class="value" id="visibility">-- km</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-sun"></i>
                    <span class="label">Sunrise</span>
                    <span class="value" id="sunrise">--:--</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-moon"></i>
                    <span class="label">Sunset</span>
                    <span class="value" id="sunset">--:--</span>
                </div>
            </div>
        </div>
        
        <div class="satellite-section">
            <h3><i class="fas fa-satellite"></i> Satellite View</h3>
            <div class="map-controls">
                <button class="map-btn active" data-layer="base">Base Map</button>
                <button class="map-btn" data-layer="satellite">Satellite</button>
                <button class="map-btn" data-layer="clouds">Clouds</button>
                <button class="map-btn" data-layer="precipitation">Precipitation</button>
                <button class="map-btn" data-layer="temperature">Temperature</button>
            </div>
            <div id="map" class="weather-map"></div>
        </div>
    </div>
    
    <div class="error-message" id="errorMessage" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorText">Failed to load weather data</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let map;
let baseLayer;
let currentOverlay;
let weatherData;

document.addEventListener('DOMContentLoaded', function() {
    const city = '{{ city }}';
    loadWeatherData(city);
});

async function loadWeatherData(city) {
    try {
        const response = await fetch(`/api/weather/${city}`);
        const data = await response.json();
        
        if (response.ok) {
            weatherData = data;
            displayWeatherData(data);
            initializeMap(data);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('weatherContent').style.display = 'block';
        } else {
            showError(data.error || 'Failed to load weather data');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    }
}

function displayWeatherData(data) {
    document.getElementById('temperature').textContent = Math.round(data.temperature);
    document.getElementById('feelsLike').textContent = Math.round(data.feels_like);
    document.getElementById('description').textContent = data.description;
    document.getElementById('humidity').textContent = data.humidity + '%';
    document.getElementById('pressure').textContent = data.pressure + ' hPa';
    document.getElementById('windSpeed').textContent = data.wind_speed + ' m/s';
    document.getElementById('visibility').textContent = data.visibility + ' km';
    document.getElementById('sunrise').textContent = data.sunrise;
    document.getElementById('sunset').textContent = data.sunset;
    
    // Set weather icon
    const iconUrl = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
    document.getElementById('weatherIcon').src = iconUrl;
}

function initializeMap(data) {
    // Initialize Leaflet map
    map = L.map('map').setView([data.coordinates.lat, data.coordinates.lon], 10);

    // Add base tile layer (OpenStreetMap)
    baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);

    // Add marker for the city
    L.marker([data.coordinates.lat, data.coordinates.lon])
        .addTo(map)
        .bindPopup(`<b>${data.city}</b><br>${data.description}<br>${Math.round(data.temperature)}°C`)
        .openPopup();

    // Set up layer controls
    setupLayerControls(data);
}

function setupLayerControls(data) {
    const mapButtons = document.querySelectorAll('.map-btn');

    mapButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            mapButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '1';
                btn.innerHTML = btn.innerHTML.replace(' <i class="fas fa-spinner fa-spin"></i>', '');
            });

            // Add active class and loading state to clicked button
            this.classList.add('active');
            const originalText = this.innerHTML;
            this.innerHTML = originalText + ' <i class="fas fa-spinner fa-spin"></i>';
            this.style.opacity = '0.8';

            const layerType = this.dataset.layer;

            // Switch layer
            switchMapLayer(layerType, data);

            // Remove loading state after a short delay
            setTimeout(() => {
                this.innerHTML = originalText;
                this.style.opacity = '1';
            }, 1000);
        });
    });
}

function switchMapLayer(layerType, data) {
    console.log('Switching to layer:', layerType);

    // Remove current overlay if exists
    if (currentOverlay) {
        map.removeLayer(currentOverlay);
        currentOverlay = null;
    }

    // Handle base layer changes vs overlay changes
    switch(layerType) {
        case 'base':
            // Switch back to OpenStreetMap base layer
            if (baseLayer && !map.hasLayer(baseLayer)) {
                // Remove any other base layer first
                map.eachLayer(function(layer) {
                    if (layer !== baseLayer && layer._url && layer._url.includes('tile')) {
                        map.removeLayer(layer);
                    }
                });
                baseLayer.addTo(map);
            }
            console.log('Showing OpenStreetMap base layer');
            break;

        case 'satellite':
            // Replace base layer with satellite imagery
            if (baseLayer && map.hasLayer(baseLayer)) {
                map.removeLayer(baseLayer);
            }
            console.log('Loading satellite imagery');
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 18
            }).addTo(map);
            break;

        case 'clouds':
            // Ensure we have a base layer, then add clouds overlay
            ensureBaseLayer();
            console.log('Loading clouds overlay:', data.satellite_layers.clouds);
            try {
                currentOverlay = L.tileLayer(data.satellite_layers.clouds, {
                    attribution: 'Weather data © OpenWeatherMap',
                    opacity: 0.7,
                    maxZoom: 18
                });
                currentOverlay.addTo(map);

                // Handle tile load errors
                currentOverlay.on('tileerror', function(e) {
                    console.warn('Clouds tile failed to load:', e.tile.src);
                });

            } catch (error) {
                console.error('Failed to load clouds layer:', error);
                showLayerError('Clouds layer temporarily unavailable');
            }
            break;

        case 'precipitation':
            ensureBaseLayer();
            console.log('Loading precipitation overlay:', data.satellite_layers.precipitation);
            try {
                currentOverlay = L.tileLayer(data.satellite_layers.precipitation, {
                    attribution: 'Weather data © OpenWeatherMap',
                    opacity: 0.7,
                    maxZoom: 18
                });
                currentOverlay.addTo(map);

                currentOverlay.on('tileerror', function(e) {
                    console.warn('Precipitation tile failed to load:', e.tile.src);
                });

            } catch (error) {
                console.error('Failed to load precipitation layer:', error);
                showLayerError('Precipitation layer temporarily unavailable');
            }
            break;

        case 'temperature':
            ensureBaseLayer();
            console.log('Loading temperature overlay:', data.satellite_layers.temperature);
            try {
                currentOverlay = L.tileLayer(data.satellite_layers.temperature, {
                    attribution: 'Weather data © OpenWeatherMap',
                    opacity: 0.7,
                    maxZoom: 18
                });
                currentOverlay.addTo(map);

                currentOverlay.on('tileerror', function(e) {
                    console.warn('Temperature tile failed to load:', e.tile.src);
                });

            } catch (error) {
                console.error('Failed to load temperature layer:', error);
                showLayerError('Temperature layer temporarily unavailable');
            }
            break;

        default:
            console.log('Unknown layer type:', layerType);
            break;
    }
}

function ensureBaseLayer() {
    // Make sure we have a base layer for overlays
    if (!map.hasLayer(baseLayer)) {
        // Remove any satellite layer first
        map.eachLayer(function(layer) {
            if (layer._url && (layer._url.includes('arcgisonline') || layer._url.includes('satellite'))) {
                map.removeLayer(layer);
            }
        });
        baseLayer.addTo(map);
    }
}

function showLayerError(message) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(255, 107, 107, 0.95);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        max-width: 300px;
    `;
    notification.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    document.body.appendChild(notification);

    // Fade in
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
        notification.style.transition = 'all 0.3s ease';
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 10);

    // Fade out and remove
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}
</script>
{% endblock %}
