{% extends "base.html" %}

{% block title %}{{ city }} Weather - Weather Dashboard{% endblock %}

{% block content %}
<div class="weather-container">
    <div class="back-button">
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to City Selection
        </a>
    </div>
    
    <div class="weather-header">
        <h2 id="cityName">{{ city }}</h2>
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading weather data...
        </div>
    </div>
    
    <div class="weather-content" id="weatherContent" style="display: none;">
        <div class="weather-main">
            <div class="current-weather">
                <div class="weather-icon">
                    <img id="weatherIcon" src="" alt="Weather Icon">
                </div>
                <div class="temperature">
                    <span id="temperature">--</span>°C
                    <div class="feels-like">
                        Feels like <span id="feelsLike">--</span>°C
                    </div>
                </div>
                <div class="weather-description">
                    <span id="description">--</span>
                </div>
            </div>
            
            <div class="weather-details">
                <div class="detail-item">
                    <i class="fas fa-tint"></i>
                    <span class="label">Humidity</span>
                    <span class="value" id="humidity">--%</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-gauge-high"></i>
                    <span class="label">Pressure</span>
                    <span class="value" id="pressure">-- hPa</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-wind"></i>
                    <span class="label">Wind Speed</span>
                    <span class="value" id="windSpeed">-- m/s</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-eye"></i>
                    <span class="label">Visibility</span>
                    <span class="value" id="visibility">-- km</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-sun"></i>
                    <span class="label">Sunrise</span>
                    <span class="value" id="sunrise">--:--</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-moon"></i>
                    <span class="label">Sunset</span>
                    <span class="value" id="sunset">--:--</span>
                </div>
            </div>
        </div>
        
        <div class="satellite-section">
            <h3><i class="fas fa-satellite"></i> Satellite View</h3>
            <div class="map-controls">
                <button class="map-btn active" data-layer="base">Base Map</button>
                <button class="map-btn" data-layer="satellite">Satellite</button>
                <button class="map-btn" data-layer="clouds">Clouds</button>
                <button class="map-btn" data-layer="precipitation">Precipitation</button>
                <button class="map-btn" data-layer="temperature">Temperature</button>
            </div>
            <div id="map" class="weather-map"></div>
        </div>
    </div>
    
    <div class="error-message" id="errorMessage" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorText">Failed to load weather data</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let map;
let currentLayer;
let weatherData;

document.addEventListener('DOMContentLoaded', function() {
    const city = '{{ city }}';
    loadWeatherData(city);
});

async function loadWeatherData(city) {
    try {
        const response = await fetch(`/api/weather/${city}`);
        const data = await response.json();
        
        if (response.ok) {
            weatherData = data;
            displayWeatherData(data);
            initializeMap(data);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('weatherContent').style.display = 'block';
        } else {
            showError(data.error || 'Failed to load weather data');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    }
}

function displayWeatherData(data) {
    document.getElementById('temperature').textContent = Math.round(data.temperature);
    document.getElementById('feelsLike').textContent = Math.round(data.feels_like);
    document.getElementById('description').textContent = data.description;
    document.getElementById('humidity').textContent = data.humidity + '%';
    document.getElementById('pressure').textContent = data.pressure + ' hPa';
    document.getElementById('windSpeed').textContent = data.wind_speed + ' m/s';
    document.getElementById('visibility').textContent = data.visibility + ' km';
    document.getElementById('sunrise').textContent = data.sunrise;
    document.getElementById('sunset').textContent = data.sunset;
    
    // Set weather icon
    const iconUrl = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
    document.getElementById('weatherIcon').src = iconUrl;
}

function initializeMap(data) {
    // Initialize Leaflet map
    map = L.map('map').setView([data.coordinates.lat, data.coordinates.lon], 10);
    
    // Add base tile layer
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add marker for the city
    L.marker([data.coordinates.lat, data.coordinates.lon])
        .addTo(map)
        .bindPopup(`<b>${data.city}</b><br>${data.description}<br>${Math.round(data.temperature)}°C`)
        .openPopup();
    
    // Set up layer controls
    setupLayerControls(data);
}

function setupLayerControls(data) {
    const mapButtons = document.querySelectorAll('.map-btn');
    
    mapButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            mapButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const layerType = this.dataset.layer;
            switchMapLayer(layerType, data);
        });
    });
}

function switchMapLayer(layerType, data) {
    // Remove current overlay layer if exists
    if (currentLayer) {
        map.removeLayer(currentLayer);
    }

    // Add new layer based on type
    switch(layerType) {
        case 'satellite':
            console.log('Loading satellite view');
            currentLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 18
            }).addTo(map);
            break;
        case 'clouds':
            console.log('Loading clouds layer:', data.satellite_layers.clouds);
            try {
                currentLayer = L.tileLayer(data.satellite_layers.clouds, {
                    attribution: 'Weather data © OpenWeatherMap',
                    opacity: 0.6,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).addTo(map);
            } catch (error) {
                console.error('Failed to load clouds layer:', error);
                showLayerError('Clouds layer temporarily unavailable');
            }
            break;
        case 'precipitation':
            console.log('Loading precipitation layer:', data.satellite_layers.precipitation);
            try {
                currentLayer = L.tileLayer(data.satellite_layers.precipitation, {
                    attribution: 'Weather data © OpenWeatherMap',
                    opacity: 0.6,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).addTo(map);
            } catch (error) {
                console.error('Failed to load precipitation layer:', error);
                showLayerError('Precipitation layer temporarily unavailable');
            }
            break;
        case 'temperature':
            console.log('Loading temperature layer:', data.satellite_layers.temperature);
            try {
                currentLayer = L.tileLayer(data.satellite_layers.temperature, {
                    attribution: 'Weather data © OpenWeatherMap',
                    opacity: 0.6,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).addTo(map);
            } catch (error) {
                console.error('Failed to load temperature layer:', error);
                showLayerError('Temperature layer temporarily unavailable');
            }
            break;
        case 'base':
        default:
            console.log('Showing base map only');
            // Base map only, no overlay
            break;
    }
}

function showLayerError(message) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff6b6b;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 10000;
        font-size: 14px;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}
</script>
{% endblock %}
