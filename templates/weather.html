{% extends "base.html" %}

{% block title %}{{ city }} Weather - Weather Dashboard{% endblock %}

{% block content %}
<div class="weather-container">
    <div class="back-button">
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to City Selection
        </a>
    </div>
    
    <div class="weather-header">
        <h2 id="cityName">{{ city }}</h2>
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading weather data...
        </div>
    </div>
    
    <div class="weather-content" id="weatherContent" style="display: none;">
        <div class="weather-main">
            <div class="current-weather">
                <div class="weather-icon">
                    <img id="weatherIcon" src="" alt="Weather Icon">
                </div>
                <div class="temperature">
                    <span id="temperature">--</span>°C
                    <div class="feels-like">
                        Feels like <span id="feelsLike">--</span>°C
                    </div>
                </div>
                <div class="weather-description">
                    <span id="description">--</span>
                </div>
            </div>
            
            <div class="weather-details">
                <div class="detail-item">
                    <i class="fas fa-tint"></i>
                    <span class="label">Humidity</span>
                    <span class="value" id="humidity">--%</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-gauge-high"></i>
                    <span class="label">Pressure</span>
                    <span class="value" id="pressure">-- hPa</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-wind"></i>
                    <span class="label">Wind Speed</span>
                    <span class="value" id="windSpeed">-- m/s</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-eye"></i>
                    <span class="label">Visibility</span>
                    <span class="value" id="visibility">-- km</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-sun"></i>
                    <span class="label">Sunrise</span>
                    <span class="value" id="sunrise">--:--</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-moon"></i>
                    <span class="label">Sunset</span>
                    <span class="value" id="sunset">--:--</span>
                </div>
            </div>
        </div>
        
        <div class="satellite-section">
            <h3><i class="fas fa-satellite"></i> Satellite View</h3>
            <div class="map-controls">
                <button class="map-btn active" data-layer="base">Base Map</button>
                <button class="map-btn" data-layer="clouds">Clouds</button>
                <button class="map-btn" data-layer="precipitation">Precipitation</button>
                <button class="map-btn" data-layer="temperature">Temperature</button>
            </div>
            <div id="map" class="weather-map"></div>
        </div>
    </div>
    
    <div class="error-message" id="errorMessage" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorText">Failed to load weather data</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let map;
let currentLayer;
let weatherData;

document.addEventListener('DOMContentLoaded', function() {
    const city = '{{ city }}';
    loadWeatherData(city);
});

async function loadWeatherData(city) {
    try {
        const response = await fetch(`/api/weather/${city}`);
        const data = await response.json();
        
        if (response.ok) {
            weatherData = data;
            displayWeatherData(data);
            initializeMap(data);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('weatherContent').style.display = 'block';
        } else {
            showError(data.error || 'Failed to load weather data');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    }
}

function displayWeatherData(data) {
    document.getElementById('temperature').textContent = Math.round(data.temperature);
    document.getElementById('feelsLike').textContent = Math.round(data.feels_like);
    document.getElementById('description').textContent = data.description;
    document.getElementById('humidity').textContent = data.humidity + '%';
    document.getElementById('pressure').textContent = data.pressure + ' hPa';
    document.getElementById('windSpeed').textContent = data.wind_speed + ' m/s';
    document.getElementById('visibility').textContent = data.visibility + ' km';
    document.getElementById('sunrise').textContent = data.sunrise;
    document.getElementById('sunset').textContent = data.sunset;
    
    // Set weather icon
    const iconUrl = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
    document.getElementById('weatherIcon').src = iconUrl;
}

function initializeMap(data) {
    // Initialize Leaflet map
    map = L.map('map').setView([data.coordinates.lat, data.coordinates.lon], 10);
    
    // Add base tile layer
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add marker for the city
    L.marker([data.coordinates.lat, data.coordinates.lon])
        .addTo(map)
        .bindPopup(`<b>${data.city}</b><br>${data.description}<br>${Math.round(data.temperature)}°C`)
        .openPopup();
    
    // Set up layer controls
    setupLayerControls(data);
}

function setupLayerControls(data) {
    const mapButtons = document.querySelectorAll('.map-btn');
    
    mapButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            mapButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const layerType = this.dataset.layer;
            switchMapLayer(layerType, data);
        });
    });
}

function switchMapLayer(layerType, data) {
    // Remove current overlay layer if exists
    if (currentLayer) {
        map.removeLayer(currentLayer);
    }
    
    // Add new layer based on type
    switch(layerType) {
        case 'clouds':
            // Note: This is a demo URL - you'll need a valid API key
            currentLayer = L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=demo', {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6
            }).addTo(map);
            break;
        case 'precipitation':
            currentLayer = L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=demo', {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6
            }).addTo(map);
            break;
        case 'temperature':
            currentLayer = L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=demo', {
                attribution: 'Weather data © OpenWeatherMap',
                opacity: 0.6
            }).addTo(map);
            break;
        case 'base':
        default:
            // Base map only, no overlay
            break;
    }
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}
</script>
{% endblock %}
